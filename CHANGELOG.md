# Change Log

All notable changes to this project will be documented in this file.  
The format is based on [Keep a Changelog](http://keepachangelog.com/).


-------------------------------


#### [v1.0](https://gitlab.com/nodiscc/xsrv/-/releases#1.0) - UNRELEASED

This is a major rewrite of the previous version. It improves usability, portability, standards compliance, separation of concerns, performance, documentation, security and adds many new features to all roles/components. There is no easy upgrade path from previous releases, you must redeploy to a new instance, and restore backups or export of your services.

A summary of changes is included below. See [README.md](README.md) for more information.


**tools, documentation, misc:**
- refactor and update documentation (clarify/cleanup/update/reorder/reword/simplify/deduplicate/move)
- import all roles from separate repositories to single repository
- publish roles and default playbook as ansible collection (https://galaxy.ansible.com/nodiscc/xsrv)
- fix automated tests (ansible-lint, yamllint, shellcheck), add ansible-playbook --syntax-check test
- remove .gitignore, clean files generated by tests using 'make clean'
- remove pip install requirements (performed by xsrv script)
- move to release/dev/tag branching/release model
- generate TODO.md file with 'make update_todo'

**xsrv command-line tool**
- refactor all command-line usage, see xsrv help
- refactor main script/simplify/cleanup
- improve logging
- make installation to $PATH optional
- add xsrv logs command (view host system logs using lnav)

**example playbook: refactor:**
- add exampless for playbook, inventory, and host_vars (cleartext and vaulted) files
- firewall: allow incoming traffic for apache and netdata by default (default enabled roles)
- auto-restart services by default when needrestart detects a restart is required
- netdata: enable default process checks for ssh, fail2ban, ntp, httpd, sql
- firewall: allow HTTP/HTTPS access from anywhere (required for let's encrypt http-01 challenge)
- firewall examples: allow access to all services only from LAN by default
- firewall: change the default policy for the 'global' firehol_network definition to RETURN (changes nothing in the default configuration, makes adding other network definitions easier)
- move example files to playbooks/xsrv
- simplify default host_vars file, update according to latest revisions of all roles
- use .ansible-vault-password as vault password file
- add example .gitlab-ci.yml
- remove unused directories, cleanup


**common: refactor role:**
- import from https://gitlab.com/nodiscc/ansible-xsrv-common
- sshd: make ssh server log level confgiurable
- doc: add example firewall rule for jitsi
- unattended-upgrades: allow automatic upgrades from stable-updates repository
- update role metadata, update doc, add notice about AllowTcpForwarding hardening
- firewall: make firewall config file only readable by root
- sshd: remove deprecated UsePrivilegeSeparation option
- sshd: explicitely deny AllowTcpForwarding, AllowAgentForwarding, GatewayPorts and X11Forwarding for the sftponly group
- simplify user management, remove *remotebackup* options/special remotebackup user
- let linux_users: variables handle creation of account for remote backups, remove special case
- make linux_users: compatible with ansible users module syntax, with added ssh_authorized_keys and sudo_nopasswd_commands parameters
- add ansible_user_allow_sudo_rsync_nopasswd option (allow ansible user to run sudo rsync without password)
- common: users: fix user password generation (use random salt, make task idempotent by setting update_password: on_create by default)
- use ansible-vault to store secret values by default
- use new syntax for ansible facts/distribution release
- require manual configuration of msmtp host/username/password (if msmtp installation is enabled)
- firewall: use an alias/variable to define LAN IP networks, templatize
- allow outgoing mail submission/port 587 by default
- common: add ability to configure multiple DNS nameservers in /etc/resolv.conf
- enable haveged installation by default
- fix running in check mode, fix sudoers syntax
- sshd: fix accepted environment variables LANG,LC_* accepted from the client
- sshd: add curve25519-sha256@libssh.org KexAlgorithm
- firewall/fail2ban: prevent firehol from overwriting fail2Ban rules, remove interaction/integration between services
- split firewall and fail2Ban configuration tasks, add ability to disable both
- make more fail2Ban settings configurable (destination e-mail, default findtime/maxretry/bantime)
- update documentation
- various fixes, cleanup, formatting


**monitoring: refactor role:**
- import from https://gitlab.com/nodiscc/ansible-xsrv-monitoring
- install and configure https://gitlab.com/nodiscc/netdata-logcount netdata module, disable notifications by default
- rsyslog: fix syslog tags for imfile watches
- disable aggregation of netdata logs to /var/log/syslog by default (very noisy, many false-positive ERROR messages)
- update documentation, fix ansible tags
- reorder, cleanup
- upgrade netdata to 1.24.0
- disable web server gzip compression since we only use ssl
- make netdata dbengine disk space size and memory page cache size configurable
- disable netdata cloud features by default, add netdata_cloud_enabled variable to configure it
- update documentation
- needrestart: don't auto-restart services by default
- disable netdata access logs and debug logs by default (performance), add netdata_disable_*_log variables to configure it
- monitor mysql server if mariadb role is enabled (add netdata mysql user)
- netdata: add ssl/x509 expiration checks, make http check timeout value optional, default to 1s)
- rsyslog: make agregation of apache access logs to syslog optional, disable by default
- various fixes
- rsyslog: monitor samba log files with imfile module


**backup role**
- import from https://gitlab.com/nodiscc/ansible-xsrv-backup
- auto-load rsnapshot configuration from /etc/rsnapshot.d/*.conf, remove hardcoded xsrv* roles integration
- check rsnapshot configuration after copying files
- restrict access to backups directory to root only
- write rsnapshot last success time to file
- store ssh public key to ansible facts (this will allow generating a human readable document/dashboard with hosts information)

**lamp role: refactor:**
- import from https://gitlab.com/nodiscc/ansible-xsrv-lamp
- split lamp role to separate apache and mariadb roles


**apache: refactor role:**
- use apache mod-md for Let's Encrypt certificate generation, remove certbot and associated ansible tasks
- rename cert_mode variable to https_mode
- don't enable mod-deflate by default
- remove SSLEngine directive from common SSL configuration (SSLEngine must be at the same level as the SSLCertificateFile directive)
- remove automatic homepage generation feature (will be split to separate role)
- always install libapache2-mod-md/apache2 from buster-backports, newer version with ACMEv2 support required
- the role depends on common role for apt backports sources installation/update apt cache handler
- update doc, cleanup, formatting, add screenshot
- use ansible-vault to manage secret variables
- do not setup any virtualhost by default
- require manual configuration of the letsencrypt admin email address
- move common mod_md settings to apache role
- enforce root:www-data ownership and mode 0750 on virtualhosts documentroots
- disable X-Frame-Options header as Content-Security-Policy frame-ancestors replaces/obsoletes it
- relax default CSP frame-ancestors settting to 'self' (displaying iframes from same domain+port+scheme is allowed)


**nextcloud: refactor role:**
- import from https://gitlab.com/nodiscc/ansible-xsrv-nextcloud
- determine appropriate setup procedure depending on whether nextcloud is already installed or not, installed version and current role version (installation/upgrades are now idempotent)
- add support for let's encrypt certificates (use mod_md when nextcloud_rss_https_mode: letsencrypt. else generate self-signed certificates)
- use ansible local fact file to store nextcloud installed version
- ensure correct/restrictive permissions are set
- support postgresql as database engine, make it the default
- move apache configuration steps to separate file, add full automatic virtualhost configuration for nextcloud
- reorder setup procedure (setup apache last)
- use ansible-vault to manage secret variables by default
- enable additional php modules https://docs.nextcloud.com/server/16/admin_manual/installation/source_installation.html#apache-web-server-configuration
- reload apache instead of restarting when possible
- update documentation, add screenshots
- templatize nextcloud domain name/install directory/full URL
- require manual configuration of nextcloud FQDN
- upgrade nextcloud to 19.0.0, upgrade all nextcloud apps
- add fine-grained ansible tags
- automatically install applications using occ app:install command, remove app-related variables and ansible tasks
- enable APCu memcache https://docs.nextcloud.com/server/19/admin_manual/configuration_server/caching_configuration.html
- gallery app replaced with photos app
- remove old installation directory at the end of upgrades
- make backup role fully optional, check rsnapshot configuration after copying config file
- delegate database backups to the respective database role (mariadb/postgresql)
- add deck app


**tt-rss: refactor role:**
- import from https://gitlab.com/nodiscc/ansible-xsrv-tt-rss
- add support for postgresql databases, make it the default (config variable tt_rss_db_type)
- add support for postgresql backups/dumps
- make backup role fully optional, check rsnapshot configuration after copying config file
- delegate database backups to the respective database role (mariadb/postgresql)
- add support for let's encrypt certificates (use mod_md when tt_rss_https_mode: letsencrypt)
- make log destination configurable, default to blank/PHP/webserver logs
- update config.php template (remove deprecated feed_crypt_key setting)
- use ansible-vault to manage secret variables by default
- require manual configuration of admin username and tt-rss FQDN/URL
- standardize component installation order (backups/fail2ban/database first)
- simplify ansible_local.tt_rss.db_imported, always set to true
- do not use a temporary file to store admin user credentials, run mysql command directly from tasks
- add support for letsencrypt certificates/virtualhost configuration (mod_md). add tt_rss_https_mode: selfsigned/letsencrypt, move tasks to separate files
- mark plugins/themes setup tasks as unmaintained, move to separate yml files
- simplify file permissions setup/make idempotent
- update documentation
- simplify domain name/install directory/full URL templating
- rename role to `tt_rss`
- various fixes, cleanup, reordering

**Migrating tt-rss data from previous MySQL-based installation:**

```bash
# OPML import/export (including filters and some settings). Must be done before data_migration plugin if you want to keep feed categories
# on the original machine
sudo mkdir /var/www/tt-rss/export
sudo chown -R www-data:www-data /var/www/tt-rss/export/
sudo -u www-data php /var/www/tt-rss/update.php --opml-export "MYUSERNAME /var/www/tt-rss/export/export-2020-08-07.opml" # export feeds OPML
# on a client
rsync -avP my.original.machine.org:/var/www/tt-rss/export/export-2020-08-07.opml ./ # download opml export
# login to the new tt-rss instance from a browser, go to Preferences > Feeds, import OPML file

# migrate all articles from mysql to postgresql
# on the original machine
git clone https://git.tt-rss.org/fox/ttrss-data-migration
sudo chown -R root:www-data ttrss-data-migration/
sudo mv ttrss-data-migration/ /var/www/tt-rss/plugins.local/data_migration
sudo nano /var/www/tt-rss/config.php # enable data_migration in the PLUGINS array
sudo -u www-data php /var/www/tt-rss/update.php --data_user MYUSERNAME --data_export /var/www/tt-rss/export/export-2020-08-07.zip # export articles to database-agnostic format

# on the target machine
git clone https://git.tt-rss.org/fox/ttrss-data-migration
sudo chown -R root:www-data ttrss-data-migration/
sudo mv ttrss-data-migration/ /var/www/rss.example.org/plugins.local/data_migration
sudo nano /var/www/rss.example.org/config.php # enable data_migration in the PLUGINS array
rsync -avP my.original.machine.org:/var/www/tt-rss/export/export-2020-08-07.zip ./
sudo mkdir /var/www/rss.example.org/export
sudo mv export-2020-08-07.zip /var/www/rss.example.org/export
sudo chown -R root:www-data /var/www/rss.example.org/export
sudo chmod -R g+rX /var/www/rss.example.org/export/
sudo -u www-data php /var/www/rss.example.org/update.php --data_user MYUSERNAME --data_import /var/www/rss.example.org/export/export-2020-08-07.zip # it can take a while
sudo rm -r /var/www/rss.example.org/export/ # cleanup

```

**gitea: refactor role:**
- import from https://gitlab.com/nodiscc/ansible-xsrv-gitea
- make backup role fully optional, check rsnapshot configuration after copying config file
- delegate database backups to the respective database role (mariadb/postgresql)
- update documentation
- make gitea user home directory configurable
- add optional configuration variables for mailer system (enable/disable, host/user/passwod/from-address)
- use ansible-vault to handle secret variables, dont generate random passwords
- simplify domain name/location/root URL templatization
- require manual configuration of gitea instance FQDN/URL
- default admin e-mail address to admin@{{ gitea_fqdn }}

**shaarli: refactor role:**
- detect installed version from ansible fact file and appropriate install/upgrade procedure depending on installed version
- add apache configuration for shaarli, including Content-Security Policy and SSL/TLS certificate management with mod_md
- allow generation of sel-signed certificates
- make shaarli fqdn and installation directory configurable
- harden file permissions
- add rsnapshot configuration for shaarli backups
- auto-configure shaarli from ansible variables (name/user/password/timezone) + compute hash during installation
- by default, don't overwrite shaarli config when it already exists (rely on configuration from the web interface) (idempotence)
- require manual generation of shaarli password salt (40 character string)
- add documentation, add backup restoration procedure
- use ansible-vault as default source for shaarli username, password, api secret and salt
- add role to example playbook (disabled by default)



**postgresql role:**
- add basic postgresql role
- add optional integration with the backup role (automatic database backups)


**samba role:**
 - add samba file sharing server role (standalone mode)
 - make log level configurable
 - make shares configurable through samba_shares variable/list of dicts
 - make users configurable through samba_users variable/list of dicts
 - add rsnapshot backup configuration for samba
 - make shares available/browseable state configurable (default to yes)
 - update documentation




#### [v0.15](https://gitlab.com/nodiscc/xsrv/-/releases#0.15) - 2020-02-08


**Changed**

* defaults: playbook: disable all role by default except common, backup, monitoring. Users should manually enable any additional roles for their own needs
* defaults: firewall: only allow access to services from LAN (except SSH)
* defaults: lamp: add a reverseproxy directive for gitea
* move rsyslog configuration tasks from common role to monitoring role
* lamp: move all logs to single access.log, error.log files, use combined log format
* monitoring: rsyslog: log *all* messages to /var/log/rsyslog
* xsrv: upgrade ansible to 2.9.3, rename show-defaults command to help-defaults
* doc: update help and documentation
* tests: improve tests coverage

**Added**

* add Gitea self-hosted Git service/software forge role
* lamp/apache: allow defining custom reverse proxies in configuration
* add update_todo makefile target (build a list of TODOs from gitea issues)
* monitoring: let rsyslog monitor gitea and netdata logs
* common: ssh: make tcp forwarding restrictions configurable, default to no forwarding allowed

**Removed**

* monitoring: remove obsolete rsyslog 'discard' rule

**Fixed**

* tt-rss: fix backups output directory, do not overwrite database with blank schema when db is already initialized, fix missing become directive, fix permissions on ansible facts files
* monitoring: fix idempotence of SSL certificate generation tasks, remove obselete rsyslog 'discard' rule
* fix ansible-lint, yamllint and shellcheck warnings
* nextcloud: fix rsnapshot output directory
* fix ansible-galaxy roles metadata
* add missing licenses

-------------------------------


#### [v0.14](https://gitlab.com/nodiscc/xsrv/-/releases#0.13) - 2020-01-20

**Added**

- new feature: [Tiny Tiny RSS feed reader](https://gitlab.com/nodiscc/ansible-xsrv-tt-rss)
- monitoring: upgrade netdata to [1.19.0](https://github.com/netdata/netdata/releases/tag/v1.19.0)
- backup: (optional) auto-backup tt-rss database if tt-rss role is installed
- nextcloud: add Notes app

**Changed**

- monitoring: decrease frequency of apache status checks to 10 seconds (decrease log spam)
- update documentation
- backup: decrease rsnapshot verbosity/log level to 'verbose'
- nextcloud: update calendar app to 2.0.0, set a random database password by default, disable recommendations app
- lamp: use NCSA combined log format
- xsrv: update ansible to 2.8.8, work on the first host from the playbook - don't error on multiple hosts

**Fixed**

- nextcloud: fix content-security-policy header when nextcloud is not installed in the default location
- nextcloud: backup: only backup the nextcloud database not all mysql databases, fix fail2ban jail configuration file permissions


-------------------------------


#### [v0.13](https://gitlab.com/nodiscc/xsrv/-/releases#0.13) - 2020-01-14

<!--
**Changed**
**Added**
**Removed**
**Fixed**
**Security**
**Deprecated**
-->

This is a rewrite of https://github.com/nodiscc/srv01 with better separation of components, documentation, testing, simplified configuration, instalaltion and usage. An archive of the old repository is attached.